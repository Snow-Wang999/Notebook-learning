# 47-Data Leakage（数据泄露）

找到并解决这个以微妙的方式破坏你的模型的问题。

在本教程中，您将了解什么是数据泄漏以及如何防止它。如果你不知道如何预防，泄漏就会经常出现，它会以微妙而危险的方式毁掉你的模型。因此，这是实践数据科学家最重要的概念之一。

## 介绍

当您的**训练数据包含有关目标的信息**时，就会发生数据泄漏（或泄漏），但是当模型用于预测时，类似的数据将不可用。这会导致训练集（甚至可能是验证数据）的高性能，但模型在生产中的表现会很差。 

换句话说，泄漏会导致**模型看起来准确，直到您开始使用模型做出决策，然后模型变得非常不准确**。 

泄漏主要有两种类型：**目标泄漏（target leakage）**和**训练测试污染（train-test contamination）**

### Target leakage-目标泄漏

target值出现之后改变的feature不可用。

---

当您的预测变量包含在您进行预测时不可用的数据时，就会发生目标泄漏。重要的是要根据数据可用的**时间或时间顺序（ *timing or chronological order*）**来考虑目标泄漏，而不仅仅是某个特征是否有助于做出良好的预测。 

一个例子会有所帮助。想象一下，您想预测谁会患上肺炎。原始数据的前几行如下所示：

![image-20221118224005666](C:\Users\Myste\AppData\Roaming\Typora\typora-user-images\image-20221118224005666.png)

人们在患上肺炎后服用抗生素药物以康复。原始数据显示这些列之间存在很强的关系，但在确定 `got_pneumonia` 的值后，`take_antibiotic_medicine` 经常发生变化。这是目标泄漏。

该模型会发现任何人的 take_antibiotic_medicine 值为 False 都没有患肺炎。由于验证数据来自与训练数据相同的来源，因此模式将在验证中重复自身，并且模型将具有很高的验证（或交叉验证）分数。

但是，当随后将模型部署到现实世界中时，该模型将非常不准确，因为当我们需要预测他们未来的健康状况时，即使是会患肺炎的患者也可能还没有接受抗生素治疗。 

为防止此类数据泄漏，应排除在实现目标值后更新（或创建）的任何变量。

![image-20221118224416252](C:\Users\Myste\AppData\Roaming\Typora\typora-user-images\image-20221118224416252.png)

### Train-Test Contamination-训练测试污染

在预处理的拟合之前，拆分训练集与测试集

---

当您不注意区分训练数据和验证数据时，会发生另一种类型的泄漏。 

回想一下，验证旨在**衡量模型如何处理之前未考虑过的数据**。如果验证数据影响预处理行为，您可能会以微妙的方式破坏此过程。这有时被称为**训练测试污染**。 

例如，假设您在调用 train_test_split() 之前运行预处理（例如为缺失值拟合输入器）。最后的结果？您的模型可能会获得良好的验证分数，让您对它充满信心，但在您部署它来做出决策时表现不佳。 

毕竟，您将来自验证或测试数据的数据合并到您进行预测的方式中，因此即使它不能推广到新数据，也可能在该特定数据上表现良好。当您进行更复杂的特征工程时，这个问题会变得更加微妙（也更加危险）。 

如果您的验证基于简单的训练-测试拆分，请从任何类型的拟合中排除验证数据，包括预处理步骤的拟合。如果您使用 scikit-learn 管道，这会更容易。使用交叉验证时，在管道内进行预处理更为重要！

## Example

在此示例中，您将学习一种检测和消除目标泄漏的方法。 

我们将使用有关信用卡应用程序的数据集并跳过基本数据设置代码。最终结果是每个信用卡申请的信息都存储在 DataFrame X 中。我们将使用它来预测哪些申请在系列 y 中被接受。

```python
import pandas as pd

# Read the data
data = pd.read_csv('../input/AER_credit_card_data.csv', 
                   true_values = ['yes'], false_values = ['no'])

# Select target
y = data.card

# Select predictors
X = data.drop(['card'], axis=1)

print("Number of rows in the dataset:", X.shape[0])
X.head()
```

![image-20221118225310404](C:\Users\Myste\AppData\Roaming\Typora\typora-user-images\image-20221118225310404.png)

由于这是一个小数据集，我们将使用交叉验证来确保模型质量的准确测量。

```python
from sklearn.pipeline import make_pipeline
from sklearn.ensemble import RandomForestClassifier
from sklearn.model_selection import cross_val_score

# Since there is no preprocessing, we don't need a pipeline (used anyway as best practice!)
my_pipeline = make_pipeline(RandomForestClassifier(n_estimators=100))
cv_scores = cross_val_score(my_pipeline, X, y, 
                            cv=5,
                            scoring='accuracy')

print("Cross-validation accuracy: %f" % cv_scores.mean())
```

```
Cross-validation accuracy: 0.979537
```

凭借经验，您会发现很难找到 98% 的时间都准确的模型。它发生了，但它并不常见，我们应该更仔细地检查数据是否有目标泄漏。 

以下是数据摘要，您也可以在数据选项卡下找到：

- card: 如果接受信用卡申请则为 1，否则为 0 
- reports：主要贬损报告的数量 
- age: 年龄 n 岁加上 12 岁 
- income：年收入（除以10,000） 
- share：每月信用卡支出与年收入的比率 
- expenditure：平均每月信用卡支出 
- owner：如果拥有房屋则为 1，如果出租则为 0 
- selfempl：如果是个体经营者则为 1，否则为 0 
- dependents：1 + 家属人数 
- months：住在当前地址的月份 
- majorcards：持有的主要信用卡数量 
- active：活跃信用账户数

一些变量看起来很可疑。例如，支出是指这张卡的支出，还是申请前用过的卡的支出？ 

在这一点上，基本的数据比较会很有帮助：

```python
expenditures_cardholders = X.expenditure[y]
expenditures_noncardholders = X.expenditure[~y]

print('Fraction of those who did not receive a card and had no expenditures: %.2f' \
      %((expenditures_noncardholders == 0).mean()))
print('Fraction of those who received a card and had no expenditures: %.2f' \
      %(( expenditures_cardholders == 0).mean()))
```

```
Fraction of those who did not receive a card and had no expenditures: 1.00
Fraction of those who received a card and had no expenditures: 0.02
```

没有收到卡且没有支出的人的比例：1.00 

收到卡但没有支出的人的比例：0.02

如上图，没有领卡的人都没有消费，而有领卡的只有2%没有消费。我们的模型似乎具有很高的准确性也就不足为奇了。不过这好像也是target leakage的情况，这里的spending大概就是他们申请的卡的消费。 

由于份额（`share`）部分由支出（`expenditures`）决定，因此也应将其排除在外。变量 `active` 和 `majorcards` 不太清楚，但从描述来看，它们听起来令人担忧。在大多数情况下，如果您无法追踪创建数据的人以了解更多信息，最好的方法是变得安全而不是后悔。 

我们将运行一个没有目标泄漏的模型，如下所示：

```python
# Drop leaky predictors from dataset
potential_leaks = ['expenditure', 'share', 'active', 'majorcards']
X2 = X.drop(potential_leaks, axis=1)

# Evaluate the model with leaky predictors removed
cv_scores = cross_val_score(my_pipeline, X2, y, 
                            cv=5,
                            scoring='accuracy')

print("Cross-val accuracy: %f" % cv_scores.mean())
```

```
Cross-val accuracy: 0.832440
```

这个准确度要低很多，这可能会令人失望。然而，我们可以预期它在用于新应用程序时大约有 80% 的时间是正确的，而泄漏模型可能会比这差得多（尽管它在交叉验证中的表观得分更高）。

## 结论 

在许多数据科学应用程序中，数据泄漏可能是数百万美元的错误。训练和验证数据的仔细分离可以防止训练测试污染，而管道可以帮助实现这种分离。同样，谨慎、常识和数据探索的结合可以帮助识别目标泄漏。

## 下一步是什么？ 

这可能看起来仍然很抽象。尝试思考本练习中的示例，以培养您识别目标泄漏和训练测试污染的技能！

## Exercise: Data Leakage

大多数人发现目标泄漏非常棘手，直到他们思考了很长时间。 

因此，在尝试考虑房价示例中的泄漏之前，我们将通过其他应用程序中的一些示例。一旦您回到有关房价的问题，事情就会变得更加熟悉。

### 设置

以下问题将为您提供有关答案的反馈。运行以下单元格以设置反馈系统。

```python
# Set up code checking
from learntools.core import binder
binder.bind(globals())
from learntools.ml_intermediate.ex7 import *
print("Setup Complete")
```

### 第 1 步：鞋带(Shoelaces)的数据科学

耐克聘请您担任数据科学顾问，帮助他们节省鞋材费用。您的第一项任务是查看他们的一名员工构建的模型，该模型用于预测他们每月需要多少条鞋带。进入机器学习模型的特征包括：

- 当前月份（一月、二月等） 

- 上月广告支出 

- 截至本月初的各种宏观经济特征（如失业率） 

- 他们在当月最终使用的皮革量 

结果表明，如果包含有关他们使用了多少皮革的特征，该模型几乎是完全准确的。但是，如果您将该功能排除在外，它只是适度准确。你意识到这是因为他们使用的皮革量是他们生产多少鞋的完美指标，这反过来又告诉你他们需要多少鞋带。 

您认为使用过的皮革特征是否构成数据泄露的来源？如果您的回答是“取决于”，它取决于什么？ 

在您考虑了您的答案之后，请对照下面的解决方案进行核对。

这很棘手，它取决于**数据收集方式的细节**（这在考虑泄漏时很常见）。您会在月初决定当月使用多少皮革吗？如果是这样，这没关系。但是，如果这是在一个月内确定的，那么您在进行预测时将无法访问它。如果你在月初有一个猜测，随后在当月更改，当月实际使用的金额不能作为特征（因为它会导致泄漏）。

### 第 2 步：归还鞋带

你有一个新的想法。您可以使用耐克在给定月份之前订购的皮革数量（而不是他们实际使用的数量）作为鞋带模型的预测指标。 

这是否会改变您对是否存在泄漏问题的回答？如果您回答“取决于”，它取决于什么？

这可能没问题，但这取决于他们是**先订购鞋带还是先订购皮革**。如果他们先订购鞋带，那么当您预测他们的鞋带需求时，您将不知道他们订购了多少皮革。如果他们先订购皮革，那么您在下鞋带订单时就会有那个号码，您应该没问题。

### 第 3 步：通过加密货币致富？(Getting Rich With Cryptocurrencies)

你为耐克省了很多钱，他们给了你一笔奖金。恭喜。 

你的朋友也是一名数据科学家，他说他建立了一个模型，可以让你把奖金变成数百万美元。具体来说，他的模型在预测时刻前一天预测了一种新的加密货币（如比特币，但更新的一种）的价格。他的计划是在模型显示货币价格（以美元计）即将上涨时购买加密货币。 

他的模型中最重要的特征是： 

- 货币的当前价格 
- 最近24小时售出的币种数量 
- 最近24小时币价变化 
- 最近1小时币价变化 
- 过去 24 小时内提及该货币的新推文数量 

以美元计算的加密货币的价值在去年上下波动超过 100 美元，但他的模型的平均误差小于 1 美元。他说这证明他的模型是准确的，你应该投资他，每当模型显示货币即将上涨时就买入货币。 

他是对的吗？如果他的模型有问题，那是什么？

这里没有泄漏源。这些特征应该在你想要预测的那一刻就可用，并且在预测目标确定后，它们不太可能在训练数据中发生变化。但是，如果您不小心，他描述准确性的方式可能会产生误导。如果价格逐渐移动，今天的价格将是明天价格的准确预测指标，但它可能无法告诉您现在是否是投资的好时机。例如，如果它今天是100，一个模型预测了明天的价格是100似乎是准确的，即使它无法告诉您价格是否从当前价格上涨还是下跌。更好的预测目标是第二天的价格变化。如果您能够始终如一地预测价格将要上涨还是下跌（以及上涨多少），您可能会有一个成功的投资机会。

### 第 4 步：预防感染（Preventing Infections）

一家提供医疗保健的机构希望预测哪些接受罕见手术的患者有感染风险，因此它可以提醒护士在跟进这些患者时要特别小心。 

你想建立一个模型。建模数据集中的每一行都是接受手术的单个患者，预测目标是他们是否感染。 

一些外科医生可能会以提高或降低感染风险的方式进行手术。但是如何才能最好地将外科医生的信息整合到模型中呢？ 

你有一个聪明的主意。 

- 对每位外科医生进行的所有手术进行计算，并计算这些外科医生的感染率。 

- 对于数据中的每位患者，找出外科医生是谁，并将该外科医生的平均感染率作为特征插入。 

这会带来任何目标泄漏问题吗？它会带来任何火车测试污染问题吗？

这会带来目标泄漏和训练测试污染的风险（尽管如果您小心的话，可以避免这两种情况）。 

如果给定患者的结果导致其外科医生的感染率增加，则您有目标泄漏，然后将其重新插入预测模型以判断该患者是否被感染。如果仅使用我们预测的患者之前的手术来计算外科医生的感染率，则可以避免目标泄漏。为训练数据中的每个手术计算这个可能有点棘手。 

如果您使用外科医生执行的所有手术（包括来自测试集的手术）来计算这一点，您也会遇到训练测试污染问题。结果将是您的模型在测试集上看起来非常准确，即使在部署模型后它不能很好地推广到新患者。发生这种情况是因为外科医生风险特征考虑了测试集中的数据。存在测试集来估计模型在看到新数据时的表现。所以这种污染违背了测试集的目的。

### 第五步：房价（Housing Prices）

您将构建一个模型来预测房价。该模型将持续部署，以在将描述添加到网站时预测新房的价格。

以下是可用作预测指标的四个特征。 

1. 房屋面积（平方米） 
2. 同一街区房屋的平均售价 
3. 房子的经纬度 
4. 房子是否有地下室 

您有历史数据来训练和验证模型。 

哪个特征最有可能成为泄漏源？

2是目标泄漏的来源。以下是对每个功能的分析： 

1. 房子的大小在售出后不太可能改变（尽管从技术上讲是可能的）。但通常这在我们需要进行预测时可用，并且在房屋售出后不会修改数据。所以还是很安全的。 

2. 我们不知道何时更新的规则。如果在房屋售出后更新原始数据中的字段，并使用房屋的销售额来计算平均值，则构成目标泄漏的情况。在极端情况下，如果附近只有一所房子被出售，并且它是我们试图预测的房子，那么平均值将恰好等于我们试图预测的价值。一般来说，对于销售量很少的社区，该模型在训练数据上的表现会非常好。但是，当您应用该模型时，您预测的房屋尚未售出，因此此功能不会像在训练数据中那样起作用。 

3. 这些不会改变，并且会在我们想要做出预测时可用。所以这里没有目标泄漏的风险。

4.  这也不会改变，并且在我们要进行预测时可用。所以这里没有目标泄漏的风险。

### 结论 

泄漏是一个困难而微妙的问题。如果您发现了这些示例中的问题，您应该感到自豪。 现在您拥有了制作高精度模型的工具，并可以解决应用这些模型解决实际问题时出现的最困难的实际问题。 积累知识和经验的空间仍然很大。参加比赛或查看我们的数据集来练习您的新技能。 再次恭喜！